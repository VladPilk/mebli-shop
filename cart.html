<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ö–æ—à–∏–∫</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }

    .site-header {
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      padding: 10px 20px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .site-header nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 0;
      padding: 0;
      flex-wrap: wrap;
    }

    .site-header nav ul li a {
      text-decoration: none;
      font-weight: bold;
      color: #333;
      transition: color 0.2s;
    }

    .site-header nav ul li a:hover {
      color: #007bff;
    }

    h1 {
      text-align: center;
    }

    table {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px;
      border: 1px solid #ccc;
      text-align: center;
    }

    th {
      background: #eee;
    }

    .total {
      text-align: right;
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    .qty-btn {
      padding: 4px 10px;
      font-size: 16px;
      margin: 0 5px;
      cursor: pointer;
    }

    .remove-btn {
      color: red;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
    }

    .empty {
      text-align: center;
      margin-top: 40px;
      font-size: 18px;
      color: #666;
    }

    #cartCount {
      font-weight: normal;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <nav>
      <ul>
        <li><a href="index.html">üè† –ì–æ–ª–æ–≤–Ω–∞</a></li>
        <li><a href="view-products.html">ü™ë –ö–∞—Ç–∞–ª–æ–≥</a></li>
        <li><a href="cart.html">üõí –ö–æ—à–∏–∫ <span id="cartCount">(0)</span></a></li>
        <li><a href="profile.html">üë§ –ü—Ä–æ—Ñ—ñ–ª—å</a></li>
      </ul>
    </nav>
  </header>

  <h1>–í–∞—à –∫–æ—à–∏–∫</h1>
  <div id="cartContainer"></div>
  <div class="total" id="totalAmount"></div>

  <script>
    // ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É –∫–æ—à–∏–∫–∞ (–º–∞—Å–∏–≤ ‚Üí –æ–±‚Äô—î–∫—Ç)
    function convertOldCartFormat() {
      const raw = JSON.parse(localStorage.getItem("cart"));
      if (Array.isArray(raw)) {
        const newCart = {};
        raw.forEach(id => {
          newCart[id] = (newCart[id] || 0) + 1;
        });
        localStorage.setItem("cart", JSON.stringify(newCart));
      }
    }

    convertOldCartFormat();

    const cart = JSON.parse(localStorage.getItem("cart")) || {};
    const cartContainer = document.getElementById("cartContainer");
    const totalAmount = document.getElementById("totalAmount");

    if (Object.keys(cart).length === 0) {
      cartContainer.innerHTML = '<p class="empty">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</p>';
      totalAmount.textContent = "";
    } else {
      loadCartItems();
    }

    async function loadCartItems() {
      try {
        const ids = Object.keys(cart);
        const productRequests = ids.map(id =>
          fetch(`http://localhost:5000/api/products/${id}`).then(res => res.json())
        );

        const products = await Promise.all(productRequests);
        renderTable(products);
      } catch (err) {
        console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤:", err);
        cartContainer.innerHTML = '<p class="empty">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ—à–∏–∫–∞</p>';
      }
    }

    function renderTable(products) {
      let total = 0;
      const table = document.createElement("table");

      table.innerHTML = `
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞</th>
            <th>–¶—ñ–Ω–∞</th>
            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
            <th>–°—É–º–∞</th>
            <th>–î—ñ—è</th>
          </tr>
        </thead>
        <tbody>
          ${products.map(product => {
            const qty = cart[product._id] || 0;
            const sum = product.price * qty;
            total += sum;

            return `
              <tr>
                <td>${product.name}</td>
                <td>${product.price} –≥—Ä–Ω</td>
                <td>
                  <button class="qty-btn" onclick="changeQty('${product._id}', -1)">‚ûñ</button>
                  ${qty}
                  <button class="qty-btn" onclick="changeQty('${product._id}', 1)">‚ûï</button>
                </td>
                <td>${sum} –≥—Ä–Ω</td>
                <td><button class="remove-btn" onclick="removeItem('${product._id}')">üóëÔ∏è</button></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      `;

      cartContainer.innerHTML = "";
      cartContainer.appendChild(table);
      totalAmount.textContent = `–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: ${total} –≥—Ä–Ω`;

      updateCartCount();
    }

    function changeQty(id, delta) {
      const current = cart[id] || 0;
      const newQty = current + delta;

      if (newQty <= 0) {
        delete cart[id];
      } else {
        cart[id] = newQty;
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      location.reload();
    }

    function removeItem(id) {
      delete cart[id];
      localStorage.setItem("cart", JSON.stringify(cart));
      location.reload();
    }

    function updateCartCount() {
      const totalCount = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
      document.getElementById("cartCount").textContent = `(${totalCount})`;
    }

    updateCartCount();
  </script>
</body>
</html>
